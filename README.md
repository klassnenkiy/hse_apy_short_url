# Сервис сокращения ссылок

Streamlit - https://hse-apy-short-url.onrender.com/
Fastapi/Swagger - https://hse-apy-short-url.onrender.com/api/docs

## Описание проекта

Проект представляет собой сервис сокращения ссылок, который позволяет пользователям создавать короткие URL-адреса для длинных ссылок, а также управлять ими и отслеживать аналитику переходов. Сервис использует базу данных PostgreSQL для хранения информации о ссылках и пользователях, а также Redis для кэширования наиболее популярных данных, что позволяет ускорить обработку запросов.

## API Описание

### 1. Создание короткой ссылки
**Метод**: `POST /links/shorten`  
**Описание**: Создает короткую ссылку на основе оригинального URL.  
**Параметры запроса**:
```json
{
  "original_url": "https://example.com",
  "custom_alias": "myalias",  // Необязательный параметр для указания кастомного алиаса
  "expires_at": "2025-12-31T23:59:59",  // Необязательный параметр для указания времени истечения
  "project": "project_name"  // Необязательный параметр для указания проекта
}
```
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://example.com",
  "created_at": "2025-12-31T00:00:00",
  "expires_at": "2025-12-31T23:59:59",
  "project": "project_name",
  "visits": 0
}
```
2. Получение оригинальной ссылки по короткому коду
Метод: `GET /links/{short_code}`
Описание: Перенаправляет на оригинальную ссылку по короткому коду.
Пример запроса: `GET /links/abc123`
Ответ: Перенаправление на оригинальный URL.
3. Удаление ссылки
Метод: `DELETE /links/{short_code}`
Описание: Удаляет ссылку по короткому коду. Доступно только для авторизованных пользователей.
Пример запроса: `DELETE /links/abc123`
Ответ:
```json
{
  "detail": "Link archived and deleted successfully"
}
```
4. Обновление ссылки
Метод: `PUT /links/{short_code}`
Описание: Обновляет оригинальный URL для уже существующей короткой ссылки.
Пример запроса:
```json
{
  "original_url": "https://newexample.com",
  "expires_at": "2025-12-31T23:59:59",
  "project": "new_project"
}
```
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://newexample.com",
  "created_at": "2025-12-31T00:00:00",
  "expires_at": "2025-12-31T23:59:59",
  "project": "new_project",
  "visits": 0
}
```
5. Получение статистики по ссылке
Метод: `GET /links/{short_code}/stats`
Описание: Отображает статистику по ссылке, включая количество переходов, дату последнего использования и дату создания.
Пример запроса: `GET /links/abc123/stats`
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://newexample.com",
  "created_at": "2025-12-31T00:00:00",
  "visits": 10,
  "last_visited": "2025-12-31T12:00:00"
}
```
6. Поиск ссылки по оригинальному URL
Метод: `GET /links/search`
Описание: Ищет короткую ссылку по оригинальному URL.
Пример запроса: `GET /links/search?original_url=https://example.com`
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://example.com"
}
```
7. Создание кастомных ссылок (уникальный alias)
Метод: `POST /links/shorten`
Описание: Создает короткую ссылку с кастомным alias.
Пример запроса:
```json
{
  "original_url": "https://example.com",
  "custom_alias": "mycustomalias"
}
```
Ответ:
```json
{
  "short_code": "mycustomalias",
  "original_url": "https://example.com",
  "created_at": "2025-12-31T00:00:00",
  "visits": 0
}
```
8. Указание времени жизни ссылки
Метод: `POST /links/shorten`
Описание: Создает короткую ссылку с указанием времени жизни (expires_at).
Пример запроса:
```json
{
  "original_url": "https://example.com",
  "expires_at": "2025-12-31T23:59:59"
}
```
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://example.com",
  "created_at": "2025-12-31T00:00:00",
  "expires_at": "2025-12-31T23:59:59",
  "visits": 0
}
```
## Дополнительный функционал

### 1. Создание и удаление администратора через API:
- В проекте есть возможность создать администратора через API с помощью метода `POST /users/create_admin`.
- Админ имеет полный доступ ко всем функциям, включая управление пользователями и ссылками через эндпоинты `/admin`.
- Создание администратора доступно только для пользователей с правами админа.

### 2. Админ-панель для управления ссылками и пользователями:
В админ-панели доступны следующие эндпоинты:
- `GET /admin/links`: Возвращает список всех ссылок в системе.
- `DELETE /admin/links/{link_id}`: Удаляет ссылку по ее ID.
- `GET /admin/users`: Получает список всех пользователей.

### 3. Реализована очистка кэша при удалении или обновлении ссылки:
- Когда ссылка обновляется или удаляется, кеш с Redis очищается, чтобы не было старых данных.

### 4. Механизм продления срока жизни ссылки (`renew`):
- Реализован механизм продления срока жизни ссылки с помощью метода `POST /links/{short_code}/renew`.
- Ссылка продлевается на 7 дней после выполнения запроса.

### 5. Функция для получения аналитики по переходам по ссылке:
Для каждой ссылки доступна аналитика по дням, часам и по User-Agent.
Эндпоинты для аналитики:
- `GET /{short_code}/analytics/daily`: Получение дневной аналитики для конкретной ссылки.
- `GET /{short_code}/analytics/hourly`: Получение почасовой аналитики для конкретной ссылки.
- `GET /{short_code}/analytics/agents`: Получение информации о том, какие User-Agent использовались для переходов по ссылке.

### 6. Функция для работы с проектами:
- Реализована возможность группировать ссылки по проектам, что позволяет отслеживать ссылки в рамках определенных категорий.
Эндпоинты:
- `GET /links/project/{project_name}`: Получить все ссылки, относящиеся к определенному проекту.
- `GET /links/project/{project_name}/stats`: Получить статистику по проекту (общее количество переходов и уникальные IP).

### 7. Удаление неиспользуемых ссылок и управление их сроком хранения:
- Ссылки, не использовавшиеся в течение определенного времени (по умолчанию 30 дней), автоматически удаляются. В процессе удаления ссылки сохраняются в архив.
- Удаление таких ссылок осуществляется через автоматический процесс, который запускается с помощью фоновых задач.

### 8. Отправка уведомлений о скором истечении срока жизни ссылки:
- Реализована функция уведомления пользователей по электронной почте за 24 часа до истечения срока действия ссылки.
- Письмо отправляется пользователю, если у ссылки есть указанная дата истечения.

### 9. Регистрация и аутентификация с JWT:
- Для регистрации и аутентификации используется токен JWT, который передается в заголовках запроса для авторизации пользователя.
- Создание токенов доступа для пользователей доступно через эндпоинт `POST /users/token`.

### 10. Защищенные эндпоинты для авторизованных пользователей:
- Некоторые эндпоинты доступны только для авторизованных пользователей (например, создание, удаление и обновление ссылок).
- Роль пользователя проверяется через JWT-токены.

### 11. Streamlit приложение
- с полным функционалом создания, управления, обзора и аналитики коротких ссылок

## Инструкция по запуску
1. Клонируйте репозиторий:
```bash
git clone https://github.com/your-repo/link-shortener
cd link-shortener
```
2. Настройка окружения: Убедитесь, что у вас установлен Docker и Docker Compose. Создайте файл .env с необходимыми переменными окружения:
```
DATABASE_URL=postgresql+asyncpg://postgres:postgres@db/short_url
REDIS_URL=redis://redis:6379
SECRET_KEY=your-secret-key
```
3. Запуск с помощью Docker Compose:
```bash
docker-compose up --build
```
4. Переход в Swagger UI для тестирования API: После запуска сервиса API будет доступно по адресу: http://localhost:8000/docs

## Описание базы данных

В проекте используется база данных PostgreSQL с двумя основными таблицами:

### Таблица `Link`
Хранит информацию о коротких ссылках, включая оригинальный URL, короткий код, дату создания, дату истечения, количество переходов и связанного пользователя.

#### Структура таблицы:
- **id**: Идентификатор ссылки.
- **short_code**: Короткий код.
- **original_url**: Оригинальный URL.
- **custom_alias**: Кастомный alias (если есть).
- **expires_at**: Дата истечения.
- **project**: Название проекта.
- **created_at**: Дата создания ссылки.
- **visits**: Количество переходов.
- **last_visited**: Дата последнего посещения.

### Таблица `LinkVisit`
Хранит информацию о переходах по ссылке, включая IP-адрес, User-Agent, дату и время перехода.

#### Структура таблицы:
- **id**: Идентификатор перехода.
- **link_id**: Идентификатор ссылки (ссылка на таблицу `Link`).
- **ip_address**: IP-адрес пользователя.
- **user_agent**: Информация о User-Agent пользователя.
- **visited_at**: Дата и время перехода.


## Примеры запросов
### Создание короткой ссылки
```bash
POST /links/shorten
Content-Type: application/json
{
  "original_url": "https://example.com",
  "custom_alias": "myalias",
  "expires_at": "2025-12-31T23:59:59"
}
```
### Получение статистики по ссылке
```bash
GET /links/abc123/stats
```
### Удаление ссылки
```bash
DELETE /links/abc123
```
## Заключение
Этот сервис предоставляет удобный инструмент для сокращения ссылок, их управления и отслеживания аналитики переходов. Реализованы функции кэширования, группировки по проектам и дополнительные механизмы для автоматического удаления неиспользуемых ссылок.
