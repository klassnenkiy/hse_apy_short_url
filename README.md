# Сервис сокращения ссылок

## Описание проекта

Проект представляет собой сервис сокращения ссылок, который позволяет пользователям создавать короткие URL-адреса для длинных ссылок, а также управлять ими и отслеживать аналитику переходов. Сервис использует базу данных PostgreSQL для хранения информации о ссылках и пользователях, а также Redis для кэширования наиболее популярных данных, что позволяет ускорить обработку запросов.

## API Описание

### 1. Создание короткой ссылки
**Метод**: `POST /links/shorten`  
**Описание**: Создает короткую ссылку на основе оригинального URL.  
**Параметры запроса**:
```json
{
  "original_url": "https://example.com",
  "custom_alias": "myalias",  // Необязательный параметр для указания кастомного алиаса
  "expires_at": "2025-12-31T23:59:59",  // Необязательный параметр для указания времени истечения
  "project": "project_name"  // Необязательный параметр для указания проекта
}
```
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://example.com",
  "created_at": "2025-12-31T00:00:00",
  "expires_at": "2025-12-31T23:59:59",
  "project": "project_name",
  "visits": 0
}
```
2. Получение оригинальной ссылки по короткому коду
Метод: `GET /links/{short_code}`
Описание: Перенаправляет на оригинальную ссылку по короткому коду.
Пример запроса: `GET /links/abc123`
Ответ: Перенаправление на оригинальный URL.
3. Удаление ссылки
Метод: `DELETE /links/{short_code}`
Описание: Удаляет ссылку по короткому коду. Доступно только для авторизованных пользователей.
Пример запроса: `DELETE /links/abc123`
Ответ:
```json
{
  "detail": "Link archived and deleted successfully"
}
```
4. Обновление ссылки
Метод: `PUT /links/{short_code}`
Описание: Обновляет оригинальный URL для уже существующей короткой ссылки.
Пример запроса:
```json
{
  "original_url": "https://newexample.com",
  "expires_at": "2025-12-31T23:59:59",
  "project": "new_project"
}
```
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://newexample.com",
  "created_at": "2025-12-31T00:00:00",
  "expires_at": "2025-12-31T23:59:59",
  "project": "new_project",
  "visits": 0
}
```
5. Получение статистики по ссылке
Метод: `GET /links/{short_code}/stats`
Описание: Отображает статистику по ссылке, включая количество переходов, дату последнего использования и дату создания.
Пример запроса: `GET /links/abc123/stats`
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://newexample.com",
  "created_at": "2025-12-31T00:00:00",
  "visits": 10,
  "last_visited": "2025-12-31T12:00:00"
}
```
6. Поиск ссылки по оригинальному URL
Метод: `GET /links/search`
Описание: Ищет короткую ссылку по оригинальному URL.
Пример запроса: `GET /links/search?original_url=https://example.com`
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://example.com"
}
```
7. Создание кастомных ссылок (уникальный alias)
Метод: `POST /links/shorten`
Описание: Создает короткую ссылку с кастомным alias.
Пример запроса:
```json
{
  "original_url": "https://example.com",
  "custom_alias": "mycustomalias"
}
```
Ответ:
```json
{
  "short_code": "mycustomalias",
  "original_url": "https://example.com",
  "created_at": "2025-12-31T00:00:00",
  "visits": 0
}
```
8. Указание времени жизни ссылки
Метод: `POST /links/shorten`
Описание: Создает короткую ссылку с указанием времени жизни (expires_at).
Пример запроса:
```json
{
  "original_url": "https://example.com",
  "expires_at": "2025-12-31T23:59:59"
}
```
Ответ:
```json
{
  "short_code": "abc123",
  "original_url": "https://example.com",
  "created_at": "2025-12-31T00:00:00",
  "expires_at": "2025-12-31T23:59:59",
  "visits": 0
}
```
## Дополнительные функции

1. **Удаление неиспользуемых ссылок**  
   Реализована функция, которая удаляет ссылки, которые не использовались в течение N дней (по умолчанию 30 дней).  
   Ссылки, которые не были использованы более 30 дней, удаляются из базы данных и сохраняются в архив.

2. **История всех истекших ссылок**  
   Реализована возможность просматривать все ссылки, срок действия которых истек, с отображением информации о них.

3. **Группировка ссылок по проектам**  
   Реализована возможность группировать ссылки по проектам для удобства пользователей, что позволяет лучше организовывать и отслеживать ссылки.

4. **Создание ссылок для незарегистрированных пользователей**  
   Пользователи могут создавать короткие ссылки без регистрации, однако управление ссылками (удаление, обновление) доступно только для авторизованных пользователей.

5. **Кэширование наиболее популярных ссылок**  
   Реализовано кэширование с использованием Redis для популярных ссылок. Это позволяет ускорить получение данных о ссылках и их статистике.

6. **Регистрация и управление пользователями**  
   Пользователи могут зарегистрироваться и войти в систему. После авторизации они могут управлять своими ссылками, а также просматривать аналитику и статистику.


## Инструкция по запуску
1. Клонируйте репозиторий:
```bash
git clone https://github.com/your-repo/link-shortener
cd link-shortener
```
2. Настройка окружения: Убедитесь, что у вас установлен Docker и Docker Compose. Создайте файл .env с необходимыми переменными окружения:
```
DATABASE_URL=postgresql+asyncpg://postgres:postgres@db/short_url
REDIS_URL=redis://redis:6379
SECRET_KEY=your-secret-key
```
3. Запуск с помощью Docker Compose:
```bash
docker-compose up --build
```
4. Переход в Swagger UI для тестирования API: После запуска сервиса API будет доступно по адресу: http://localhost:8000/docs

## Описание базы данных

В проекте используется база данных PostgreSQL с двумя основными таблицами:

### Таблица `Link`
Хранит информацию о коротких ссылках, включая оригинальный URL, короткий код, дату создания, дату истечения, количество переходов и связанного пользователя.

#### Структура таблицы:
- **id**: Идентификатор ссылки.
- **short_code**: Короткий код.
- **original_url**: Оригинальный URL.
- **custom_alias**: Кастомный alias (если есть).
- **expires_at**: Дата истечения.
- **project**: Название проекта.
- **created_at**: Дата создания ссылки.
- **visits**: Количество переходов.
- **last_visited**: Дата последнего посещения.

### Таблица `LinkVisit`
Хранит информацию о переходах по ссылке, включая IP-адрес, User-Agent, дату и время перехода.

#### Структура таблицы:
- **id**: Идентификатор перехода.
- **link_id**: Идентификатор ссылки (ссылка на таблицу `Link`).
- **ip_address**: IP-адрес пользователя.
- **user_agent**: Информация о User-Agent пользователя.
- **visited_at**: Дата и время перехода.


## Примеры запросов
### Создание короткой ссылки
```bash
POST /links/shorten
Content-Type: application/json
{
  "original_url": "https://example.com",
  "custom_alias": "myalias",
  "expires_at": "2025-12-31T23:59:59"
}
```
### Получение статистики по ссылке
```bash
GET /links/abc123/stats
```
### Удаление ссылки
```bash
DELETE /links/abc123
```
## Заключение
Этот сервис предоставляет удобный инструмент для сокращения ссылок, их управления и отслеживания аналитики переходов. Реализованы функции кэширования, группировки по проектам и дополнительные механизмы для автоматического удаления неиспользуемых ссылок.
